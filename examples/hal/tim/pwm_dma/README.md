<img src="doc/subbrand-stm32.svg" width="50" alt="STM32 Subbrand Logo"/>

# __Example: *hal_tim_pwm_dma*__

[![User Manual](doc/read_the-UM.svg)](https://dev.st.com/stm32cube-docs/examples/latest/ "Online documentation.")

How to configure the TIM peripheral in PWM (Pulse Width Modulation) mode with variable duty cycle using DMA.
The PWM waveforms generated by the timer channels can be displayed using an oscilloscope.


## __1. Detailed scenario__

This scenario demonstrates how to configure a timer to generate PWM signal with variable duty cycle controlled by DMA.

__Initialization phase__: At the beginning of the `main()` function, the `mx_system_init()` function is called to initialize the peripherals, the flash interface, the system clock, and the SysTick.

The application executes the following __example steps__:

__Step 1__: Initializes the DMA, the timer's input clock, counter clock, output clock. Sets the output channel duty cycles, and the GPIO pins.

__Step 2__: Starts the timer PWM generation with variable duty cycle using DMA.

__End of example__: If no error occurs, the PWM signal is generated indefinitely.


## __2. Example configuration__

[![Configuration Manual](doc/configure_with-ConfigurationMa.svg)](https://dev.st.com/stm32cube-docs/examples/latest/#:~:text=config "An offline version is also available in the STM32Cube firmware package.")

__TIM__:
The *TIM* is configured as follows:

- The timer channel is configured as PWM generator in up counting PWM mode 1.
- The timer prescaler is configured to set the timer counter clock to 1 MHz.
- TIM is configured to generate DMA request at each compare event, and thus change the duty cycle at each period. The duty cycles defined by the CompareBuffer are 25%, 50% and 75%.
The DMA request is made on TIM compare event. But if PWM duty cycle is updated on compare event, in the middle of a period, then the pulse may be broken with unexpected pulse duration. To fix this, capture/compare preload is configured, so that the new compare value is taken into account on update event. PWM duty cycle is then changed synchronously with the end of its period.

Note that the timer configuration depends on the timer peripheral input clock, which is derived from the system clock tree.
So, it is required to define the system clock configuration and to determine the timer input clock before defining the timer configuration.

The system clock configuration is specific to each STM32 MCU (see section [Hardware environment and setup](#3-hardware-environment-and-setup)).

__DMA__:
Configured to transfer data from the memory to the TIM registers upon TIM request. The data is stored in a buffer, and the DMA operates in circular mode.

### __2.1. GPIO configuration__

One pin must be configured, for PWM signal: [see the specific boards setups](#32-specific-board-setups)

The GPIO pins are configured in:

- Alternate function as a timer output channel of its respective timer instance.
- Push-pull mode with no pull-up or pull-down resistors activated.


## __3. Hardware environment and setup__

### __3.1. Generic Setup__

The PWM signals generated by the timer channels can be displayed by connecting an oscilloscope to the corresponding board connectors.

    ___             _______         ___________     ___
  _|   |___________|       |_______|           |___|   |___________
   <----25% -------><----50% ------><----75% ------><----25% ------>

### __3.2. Specific board setups__

<details>

<details>
  <summary>On board NUCLEO-C562RE.</summary>

  The selected timer is TIM1, with:

  - TIM1_CH1 for channel 1

  | Board connector<br> and pin  | CPU pin | Signal name | ARDUINO<br> connector pin |
  | :---:                        | :---:   | :---:       | :---:                     |
  | CN10-23                      | PA8     | TIM1_CH1    | ARDUINO CONNECTOR - D7    |
  | CN10-11                      | PA5     | LED_STATUS  | ARDUINO CONNECTOR - D13   |

</details>
<details>
  <summary>On board NUCLEO-U575ZI-Q.</summary>

  The selected timer is TIM1, with:

  - TIM1_CH1 for channel 1

  | Board connector<br> and pin  | CPU pin | Signal name | ARDUINO<br> connector pin |
  | :---:                        | :---:   | :---:       | :---:                     |
  | CN10-4                       | PE9     | TIM1_CH1    | ARDUINO CONNECTOR - D6    |
  | CN12-19                      | PC7     | LED_STATUS  | --                        |

</details>

</details>


## __4. Troubleshooting__

[![Troubleshooting](doc/debug_with-Troubleshooting.svg)](https://dev.st.com/stm32cube-docs/examples/latest/#:~:text=Troubleshooting "An offline version is also available in the STM32Cube firmware package.")

Here are the points of attention for this specific example:

__System clock__: The timer clock depends on the system clock configuration. Changing the CPU clock or the peripheral bus' clock affects the PWM frequency and duty cycle.


## __5. See Also__

[![SeeAlso](doc/go_further_with-STM32.svg)](https://dev.st.com/stm32cube-docs/examples/latest/#:~:text=See%20Also "An offline version is also available in the STM32Cube firmware package.")

You can also refer to this other example for more timer calculation details:

- hal_tim_pwm_output: demonstrates how to use the TIM peripheral to generate a PWM signal.

This [General-purpose timer cookbook for STM32 microcontrollers (ref. AN4776)](https://www.st.com/content/ccc/resource/technical/document/application_note/group0/91/01/84/3f/7c/67/41/3f/DM00236305/files/DM00236305.pdf/jcr:content/translations/en.DM00236305.pdf) provides a simple and clear description of the basic features and operating modes of the STM32 general-purpose timer peripherals.

This [STM32 cross-series timer overview (ref. AN4013)](https://www.st.com/content/ccc/resource/technical/document/application_note/54/0f/67/eb/47/34/45/40/DM00042534.pdf/files/DM00042534.pdf/jcr:content/translations/en.DM00042534.pdf) presents an overview of the timer peripherals for the STM32 product series.

More information about the STM32Cube Drivers can be found in the drivers' user manual of the STM32 series you are using.

For instance for the STM32U5 series: [User Manual](https://www.st.com/resource/en/user_manual/dm00813340-.pdf).

More information about the STM32 ecosystem can be found in the [STM32 MCU Developer Zone](https://www.st.com/content/st_com/en/stm32-mcu-developer-zone.html).


## __6. License__

Copyright (c) 2025 STMicroelectronics.

This software is licensed under terms that can be found in the LICENSE file in the root directory
of this software component.
If no LICENSE file comes with this software, it is provided AS-IS.
